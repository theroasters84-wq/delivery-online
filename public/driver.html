<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver App - The Roasters</title>
    <style>
        body { background: #121212; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; justify-content: center; }
        .card { background: #1e1e1e; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #333; background: #252525; color: white; font-size: 1.1em; box-sizing: border-box; }
        .btn-green { background: #00ff00; color: black; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 1.2em; border: none; cursor: pointer; }
        
        /* BOT OVERLAY */
        #bot-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.98); z-index: 99999; display: none; 
            flex-direction: column; align-items: center; justify-content: center; padding: 25px; box-sizing: border-box;
        }
        .bot-bubble { background: #007bff; color: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; font-weight: bold; }
        .btn-fix { background: #ffc107; color: black; padding: 20px; width: 100%; border-radius: 15px; font-weight: bold; margin-bottom: 10px; border: none; cursor: pointer; }

        #accept-layer { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #00ff00; color: black; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; animation: blink 0.6s infinite; }
        @keyframes blink { 0% { background: #00ff00; } 50% { background: #00cc00; } 100% { background: #00ff00; } }
    </style>
</head>
<body>

    <div id="bot-overlay">
        <div class="bot-bubble">ğŸ¤– Î“ÎµÎ¹Î±! Î ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚ Î¼Î¹Î± ÏÏÎ¸Î¼Î¹ÏƒÎ· Î³Î¹Î± Î½Î± Î´Î¿Ï…Î»ÎµÏÎµÎ¹ Î· ÎµÏ†Î±ÏÎ¼Î¿Î³Î® ÏƒÏ„Î·Î½ Ï„ÏƒÎ­Ï€Î·!</div>
        <p style="color:#aaa;">Î Î¬Ï„Î± Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯, Î²ÏÎµÏ‚ Ï„Î·Î½ <strong>ÎœÏ€Î±Ï„Î±ÏÎ¯Î±</strong> ÎºÎ±Î¹ ÎµÏ€Î­Î»ÎµÎ¾Îµ <strong>Î§Ï‰ÏÎ¯Ï‚ Î ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼Î¿ÏÏ‚</strong>.</p>
        <button class="btn-fix" onclick="openBatterySettings()">1. Î‘ÎÎŸÎ™ÎÎ• Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£</button>
        <button style="background:#444; color:white; padding:15px; width:100%; border-radius:15px; border:none;" onclick="markBotAsDone()">2. Î¤ÎŸ Î•ÎšÎ‘ÎÎ‘ / Î£Î¥ÎÎ•Î§Î•Î™Î‘</button>
    </div>

    <div id="accept-layer" onclick="handleAccept()">
        <h1 style="font-size: 4em;">Î‘Î ÎŸÎ”ÎŸÎ§Î—</h1>
    </div>

    <div class="card" id="login-ui">
        <h2>ğŸ”‘ Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ ÎŸÎ´Î·Î³Î¿Ï</h2>
        <input type="password" id="pw" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚">
        <input type="text" id="shop" placeholder="ÎŒÎ½Î¿Î¼Î± ÎœÎ±Î³Î±Î¶Î¹Î¿Ï">
        <input type="text" id="name" placeholder="Î¤Î¿ ÏŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï…">
        <button class="btn-green" onclick="login()">Î£Î¥ÎÎ”Î•Î£Î—</button>
    </div>

    <div id="active-ui" style="display:none;">
        <h1 id="shop-title" style="color:#00ff00; margin-bottom:5px;"></h1>
        <p id="driver-name-display" style="margin-top:0; color:#888;"></p>
        <div style="font-size: 1.5em; margin: 30px 0;">â— ONLINE</div>
        <button onclick="logout()" style="background:none; border:none; color:#ff4757; text-decoration:underline; font-size:1em; cursor:pointer;">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ· / Î‘Î»Î»Î±Î³Î® Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const alarm = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        const VAPID_PUBLIC_KEY = 'BDeB-u_7Q0z5G_wL8k9Wz8Xp6F6R7T8Y9U0I1O2P3A4S5D6F7G8H9J0K_L1M';

        // 1. BOT CHECK
        if (!localStorage.getItem('bot_shown')) {
            document.getElementById('bot-overlay').style.display = 'flex';
        }

        function openBatterySettings() {
            alert("Î˜Î± Î±Î½Î¿Î¯Î¾Î¿Ï…Î½ Î¿Î¹ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚. Î Î¬Ï„Î± 'ÎœÏ€Î±Ï„Î±ÏÎ¯Î±' -> 'Î§Ï‰ÏÎ¯Ï‚ Ï€ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼Î¿ÏÏ‚'.");
            window.location.href = "intent://settings/#Intent;action=android.settings.APPLICATION_DETAILS_SETTINGS;data=package:com.android.chrome;end";
        }

        function markBotAsDone() {
            localStorage.setItem('bot_shown', 'true');
            document.getElementById('bot-overlay').style.display = 'none';
        }

        // 2. AUTO-FILL & AUTO-LOGIN
        window.onload = () => {
            if(localStorage.getItem('saved_pw')) document.getElementById('pw').value = localStorage.getItem('saved_pw');
            if(localStorage.getItem('saved_shop')) document.getElementById('shop').value = localStorage.getItem('saved_shop');
            if(localStorage.getItem('saved_name')) document.getElementById('name').value = localStorage.getItem('saved_name');
            
            if(localStorage.getItem('is_logged_in') === 'true') {
                start();
            }
        };

        function login() {
            const p = document.getElementById('pw').value;
            const s = document.getElementById('shop').value.toLowerCase().trim();
            const n = document.getElementById('name').value.trim();

            if(!p || !s || !n) return alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î±!");

            localStorage.setItem('saved_pw', p);
            localStorage.setItem('saved_shop', s);
            localStorage.setItem('saved_name', n);
            localStorage.setItem('is_logged_in', 'true');

            start();
        }

        async function start() {
            const shop = localStorage.getItem('saved_shop');
            const name = localStorage.getItem('saved_name');

            document.getElementById('login-ui').style.display = 'none';
            document.getElementById('active-ui').style.display = 'block';
            document.getElementById('shop-title').innerText = shop.toUpperCase();
            document.getElementById('driver-name-display').innerText = "ÎŸÎ´Î·Î³ÏŒÏ‚: " + name;

            socket.emit('driver-login', { name: name, shop: shop });

            // Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Push Notifications
            enablePush();

            // Wake Lock
            if ('wakeLock' in navigator) { navigator.wakeLock.request('screen').catch(()=>{}); }
            
            // ÎÎµÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î± Î®Ï‡Î¿Ï…
            document.addEventListener('click', () => { alarm.play().then(()=>alarm.pause()); }, {once:true});
        }

        async function enablePush() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                try {
                    const register = await navigator.serviceWorker.register('/sw.js');
                    const subscription = await register.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: VAPID_PUBLIC_KEY
                    });
                    socket.emit('save-subscription', subscription);
                } catch (err) {
                    console.log("Push Error:", err);
                }
            }
        }

        socket.on('new-order', () => {
            alarm.loop = true; 
            alarm.play().catch(()=>{});
            document.getElementById('accept-layer').style.display = 'flex';
            if(navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
        });

        function handleAccept() {
            alarm.pause(); 
            alarm.currentTime = 0;
            socket.emit('order-accepted', { 
                driverName: localStorage.getItem('saved_name'), 
                shopName: localStorage.getItem('saved_shop') 
            });
            document.getElementById('accept-layer').style.display = 'none';
        }

        function logout() {
            if(confirm("Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ· ÎºÎ±Î¹ ÎºÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½;")) {
                localStorage.removeItem('is_logged_in');
                location.reload();
            }
        }
    </script>
</body>
</html>
