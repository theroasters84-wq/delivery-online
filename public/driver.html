<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver - The Roasters</title>
    <link rel="manifest" href="/manifest-driver.json">
    <style>
        body { background: #121212; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; overflow: hidden; height: 100vh; display: flex; flex-direction: column; justify-content: center; }
        .login-card { background: #1e1e1e; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid #333; background: #252525; color: white; font-size: 1.2em; box-sizing: border-box; }
        .btn-login { background: #00ff00; color: black; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 1.3em; border: none; margin-top: 10px; cursor: pointer; }
        
        #driver-ui { display: none; }
        .status-msg { color: #00ff00; font-size: 1.5em; margin-bottom: 10px; font-weight: bold; }
        
        /* ΤΕΡΑΣΤΙΟ ΚΟΥΜΠΙ ΑΠΟΔΟΧΗΣ */
        .big-accept-btn {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #00ff00; color: black; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
            animation: flash 0.6s infinite; border: none; cursor: pointer;
        }
        @keyframes flash { 0% { background: #00ff00; } 50% { background: #00cc00; } 100% { background: #00ff00; } }
        
        .logout-btn { background: none; border: none; color: #555; text-decoration: underline; margin-top: 50px; font-size: 1em; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-ui" class="login-card">
        <h1 style="color:#00ff00;">Roasters Driver</h1>
        <input type="text" id="shop-input" placeholder="Όνομα Μαγαζιού">
        <input type="text" id="name-input" placeholder="Το όνομά σου">
        <button class="btn-login" onclick="handleLogin()">ΕΙΣΟΔΟΣ</button>
    </div>

    <div id="driver-ui">
        <h1 id="welcome-txt"></h1>
        <div class="status-msg">● ΕΙΣΑΙ ONLINE</div>
        <p style="color:#888; font-size: 1.2em;">Περιμένεις κλήση από το κατάστημα...</p>
        
        <div id="call-area"></div>
        
        <button class="logout-btn" onclick="handleLogout()">Αποσύνδεση / Αλλαγή</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        // Ήχος Σειρήνας
        const alarm = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

        // Έλεγχος για αυτόματη είσοδο
        const savedShop = localStorage.getItem('myShop');
        const savedName = localStorage.getItem('myName');

        if (savedShop && savedName) {
            setupDriver(savedName, savedShop);
        }

        function handleLogin() {
            const s = document.getElementById('shop-input').value.trim().toLowerCase();
            const n = document.getElementById('name-input').value.trim();
            if(!s || !n) return alert("Συμπλήρωσε τα στοιχεία σου!");

            localStorage.setItem('myShop', s);
            localStorage.setItem('myName', n);
            
            // Ξεκλείδωμα ήχου
            alarm.play().then(() => { alarm.pause(); alarm.currentTime = 0; }).catch(()=>{});
            
            setupDriver(n, s);
        }

        function setupDriver(name, shop) {
            document.getElementById('login-ui').style.display = 'none';
            document.getElementById('driver-ui').style.display = 'block';
            document.getElementById('welcome-txt').innerText = "Γεια σου " + name + "!";
            
            socket.emit('driver-login', { name, shop });

            // Fail-safe: Ξεκλείδωμα ήχου με το πρώτο άγγιγμα στην οθόνη
            document.body.addEventListener('click', () => {
                alarm.play().then(() => { alarm.pause(); }).catch(()=>{});
            }, { once: true });
        }

        socket.on('new-order', (data) => {
            alarm.loop = true;
            alarm.play().catch(() => { console.log("Audio blocked"); });
            if(navigator.vibrate) navigator.vibrate([1000, 500, 1000, 500, 1000]);

            document.getElementById('call-area').innerHTML = `
                <button class="big-accept-btn" onclick="confirmOrder()">
                    <h1 style="font-size: 4em; margin:0;">ΑΠΟΔΟΧΗ</h1>
                    <p style="font-size: 1.5em; margin-top:20px;">ΚΛΗΣΗ ΑΠΟ: ${data.shop.toUpperCase()}</p>
                </button>`;
        });

        function confirmOrder() {
            alarm.pause();
            alarm.currentTime = 0;
            socket.emit('order-accepted', { 
                driverName: localStorage.getItem('myName'), 
                shopName: localStorage.getItem('myShop') 
            });
            document.getElementById('call-area').innerHTML = '<h1 style="color:#00ff00; font-size:3em;">✅ ΕΡΧΟΜΑΙ!</h1>';
            setTimeout(() => { document.getElementById('call-area').innerHTML = ''; }, 5000);
        }

        function handleLogout() {
            if(confirm("Αποσύνδεση;")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
