<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver - The Roasters</title>
    <link rel="manifest" href="/manifest-driver.json">
    <style>
        body { background: #121212; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .card { background: #1e1e1e; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid #333; background: #252525; color: white; font-size: 1.2em; box-sizing: border-box; }
        .btn { background: #00ff00; color: black; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 1.2em; border: none; cursor: pointer; margin-top: 10px; }
        .setup-step { display: none; }
        .active { display: block; }
        .big-btn { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #00ff00; color: black; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; animation: blink 0.6s infinite; border: none; }
        @keyframes blink { 0% { background: #00ff00; } 50% { background: #00cc00; } 100% { background: #00ff00; } }
    </style>
</head>
<body>

    <div id="setup-wizard" class="card active">
        <div id="step1" class="setup-step active">
            <h2>ğŸ¤– Setup Driver</h2>
            <p>Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¹Ï‚ ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Î½Î± Î´Î¿Ï…Î»ÎµÏÎµÎ¹ Ï„Î¿ App.</p>
            <button class="btn" onclick="askNotification()">Î•ÎÎ•Î¡Î“ÎŸÎ ÎŸÎ™Î—Î£Î—</button>
        </div>
        <div id="step2" class="setup-step">
            <h2>ğŸ”Š Î”Î¿ÎºÎ¹Î¼Î® Î‰Ï‡Î¿Ï…</h2>
            <p>Î Î¬Ï„Î± Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹Ï‚ Ï„Î¿Î½ Î®Ï‡Î¿ Ï„Î·Ï‚ ÏƒÎµÎ¹ÏÎ®Î½Î±Ï‚.</p>
            <button class="btn" onclick="testSound()">Î”ÎŸÎšÎ™ÎœÎ—</button>
        </div>
        <div id="step3" class="setup-step">
            <h2>ğŸ”‹ ÎœÏ€Î±Ï„Î±ÏÎ¯Î±</h2>
            <p>Î’Î¬Î»Îµ Ï„Î¿ App ÏƒÏ„Î¹Ï‚ <b>"Î•Î¾Î±Î¹ÏÎ­ÏƒÎµÎ¹Ï‚ Î’ÎµÎ»Ï„Î¹ÏƒÏ„Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ ÎœÏ€Î±Ï„Î±ÏÎ¯Î±Ï‚"</b> ÏƒÏ„Î¹Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚.</p>
            <button class="btn" onclick="finishSetup()">Î¤ÎŸ Î•ÎšÎ‘ÎÎ‘</button>
        </div>
    </div>

    <div id="login-ui" class="card" style="display: none;">
        <h1>Roasters Driver</h1>
        <input type="text" id="shop-input" placeholder="ÎŒÎ½Î¿Î¼Î± ÎœÎ±Î³Î±Î¶Î¹Î¿Ï">
        <input type="text" id="name-input" placeholder="Î¤Î¿ ÏŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï…">
        <button class="btn" onclick="handleLogin()">Î•Î™Î£ÎŸÎ”ÎŸÎ£</button>
    </div>

    <div id="driver-ui" style="display: none;">
        <h1 id="welcome-txt"></h1>
        <div style="color:#00ff00; font-size: 1.5em; font-weight: bold;">â— ONLINE</div>
        <div id="call-area"></div>
        <button onclick="handleLogout()" style="background:none; border:none; color:#555; margin-top:50px; text-decoration:underline;">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const alarm = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(reg => {
                console.log('SW Registered');
            });

            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data.action === 'FORCE_ACCEPT') confirmOrder();
            });
        }

        if(localStorage.getItem('setupDone')) {
            showLogin();
            if(localStorage.getItem('myName')) autoStart();
        }

        function askNotification() {
            Notification.requestPermission().then(() => {
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step2').classList.add('active');
            });
        }

        function testSound() {
            alarm.play().then(() => {
                setTimeout(() => { alarm.pause(); alarm.currentTime = 0; }, 1000);
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step3').classList.add('active');
            });
        }

        function finishSetup() {
            localStorage.setItem('setupDone', 'true');
            showLogin();
        }

        function showLogin() {
            document.getElementById('setup-wizard').style.display = 'none';
            document.getElementById('login-ui').style.display = 'block';
        }

        function handleLogin() {
            const s = document.getElementById('shop-input').value.trim().toLowerCase();
            const n = document.getElementById('name-input').value.trim();
            if(!s || !n) return;
            localStorage.setItem('myShop', s);
            localStorage.setItem('myName', n);
            autoStart();
        }

        function autoStart() {
            const n = localStorage.getItem('myName');
            const s = localStorage.getItem('myShop');
            document.getElementById('login-ui').style.display = 'none';
            document.getElementById('driver-ui').style.display = 'block';
            document.getElementById('welcome-txt').innerText = n;
            socket.emit('driver-login', { name: n, shop: s });
            
            // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Î±Î½Î¿Î¯Î¾Î±Î¼Îµ Î±Ï€ÏŒ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚
            if (new URLSearchParams(window.location.search).get('action') === 'auto_accept') {
                setTimeout(confirmOrder, 1000);
            }
        }

        socket.on('new-order', (data) => {
            alarm.loop = true; alarm.play().catch(()=>{});
            document.getElementById('call-area').innerHTML = `
                <button class="big-btn" onclick="confirmOrder()">
                    <h1 style="font-size: 3.5em;">Î‘Î ÎŸÎ”ÎŸÎ§Î—</h1>
                    <p>ÎšÎ›Î—Î£Î—: ${data.shop.toUpperCase()}</p>
                </button>`;
        });

        function confirmOrder() {
            alarm.pause(); alarm.currentTime = 0;
            socket.emit('order-accepted', { driverName: localStorage.getItem('myName'), shopName: localStorage.getItem('myShop') });
            document.getElementById('call-area').innerHTML = '<h1 style="color:#00ff00; font-size:3em;">âœ… Î•Î“Î™ÎÎ•!</h1>';
            setTimeout(() => { document.getElementById('call-area').innerHTML = ''; }, 5000);
        }

        function handleLogout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
