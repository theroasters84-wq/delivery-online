<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver App</title>
    <link rel="manifest" href="/manifest-driver.json">
    <style>
        body { background: #121212; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .card { background: #1e1e1e; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid #333; background: #252525; color: white; font-size: 1.1em; box-sizing: border-box; }
        .btn-start { background: #00ff00; color: black; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 1.2em; border: none; cursor: pointer; }
        #accept-layer { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #00ff00; color: black; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; animation: blink 0.6s infinite; }
        @keyframes blink { 0% { background: #00ff00; } 50% { background: #00cc00; } 100% { background: #00ff00; } }
        #status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .offline { background: #ff0000; box-shadow: 0 0 10px #ff0000; }
    </style>
</head>
<body>

    <div id="accept-layer" onclick="handleAccept()">
        <h1 style="font-size: 3.5em; line-height: 1;">Î Î‘Î¤Î‘ Î“Î™Î‘<br>Î‘Î ÎŸÎ”ÎŸÎ§Î—</h1>
        <p id="caller-name" style="font-size: 1.5em; font-weight: bold; margin-top: 20px;"></p>
    </div>

    <div class="card" id="login-ui">
        <h2>ğŸ” Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</h2>
        <input type="password" id="m-key" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Î ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚">
        <input type="text" id="r-name" placeholder="ÎŒÎ½Î¿Î¼Î± Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚">
        <input type="text" id="d-name" placeholder="Î¤Î¿ ÏŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï…">
        <button class="btn-start" onclick="login()">Î•Î™Î£ÎŸÎ”ÎŸÎ£</button>
    </div>

    <div id="active-ui" style="display:none;">
        <h1 id="brand-name" style="color:#00ff00; text-transform: uppercase; margin:0;"></h1>
        <div style="margin: 15px 0;">
            <span id="status-dot" class="offline"></span>
            <span id="status-text">Î£ÏÎ½Î´ÎµÏƒÎ·...</span>
        </div>
        <p id="driver-info" style="color:#888;"></p>
        <button onclick="logout()" style="margin-top:50px; background:none; border:none; color:#555; text-decoration:underline; cursor:pointer;">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Î‘Î›Î›Î‘ÎÎ• Î¤ÎŸÎ ÎšÎ©Î”Î™ÎšÎŸ Î•Î”Î©
        const MY_SECRET_KEY = "1234"; 

        const socket = io({
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000
        });

        const alarm = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        let wakeLock = null;

        // Wake Lock Î³Î¹Î± Î½Î± Î¼Î·Î½ ÎºÎ¿Î¹Î¼Î¬Ï„Î±Î¹ Î¿ browser
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock Active');
                } catch (err) { console.log(err); }
            }
        }

        if (localStorage.getItem('d_room')) start();

        function login() {
            const key = document.getElementById('m-key').value;
            const r = document.getElementById('r-name').value.trim();
            const n = document.getElementById('d-name').value.trim();

            if(key !== MY_SECRET_KEY) return alert("Î›Î¬Î¸Î¿Ï‚ ÎšÏ‰Î´Î¹ÎºÏŒÏ‚!");
            if(!r || !n) return alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î± Ï€Î¬Î½Ï„Î±!");

            localStorage.setItem('d_room', r);
            localStorage.setItem('d_name', n);
            location.reload();
        }

        function start() {
            document.getElementById('login-ui').style.display = 'none';
            document.getElementById('active-ui').style.display = 'block';
            document.getElementById('brand-name').innerText = localStorage.getItem('d_room');
            document.getElementById('driver-info').innerText = "ÎŸÎ´Î·Î³ÏŒÏ‚: " + localStorage.getItem('d_name');

            socket.emit('driver-login', { 
                name: localStorage.getItem('d_name'), 
                shop: localStorage.getItem('d_room').toLowerCase().trim() 
            });

            requestWakeLock();
            // ÎÎµÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î± Î®Ï‡Î¿Ï… Î¼Îµ Ï„Î¿ Ï€ÏÏÏ„Î¿ ÎºÎ»Î¹Îº
            document.addEventListener('click', () => { alarm.play().then(()=>alarm.pause()); }, {once:true});
        }

        socket.on('connect', () => {
            document.getElementById('status-dot').className = "status-dot online";
            document.getElementById('status-text').innerText = "ONLINE";
            if (localStorage.getItem('d_room')) {
                socket.emit('driver-login', { 
                    name: localStorage.getItem('d_name'), 
                    shop: localStorage.getItem('d_room').toLowerCase().trim() 
                });
            }
        });

        socket.on('disconnect', () => {
            document.getElementById('status-dot').className = "status-dot offline";
            document.getElementById('status-text').innerText = "Î‘Î ÎŸÎ£Î¥ÎÎ”Î•Î”Î•ÎœÎ•ÎÎŸÎ£";
        });

        socket.on('new-order', (data) => {
            alarm.loop = true;
            alarm.play().catch(e => console.log("Audio Error"));
            document.getElementById('caller-name').innerText = "ÎšÎ›Î—Î£Î— Î‘Î ÎŸ: " + localStorage.getItem('d_room').toUpperCase();
            document.getElementById('accept-layer').style.display = 'flex';
            if(navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
        });

        function handleAccept() {
            alarm.pause(); alarm.currentTime = 0;
            socket.emit('order-accepted', { 
                driverName: localStorage.getItem('d_name'), 
                shopName: localStorage.getItem('d_room').toLowerCase().trim() 
            });
            document.getElementById('accept-layer').style.display = 'none';
        }

        function logout() { localStorage.clear(); location.reload(); }

        // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Wake Lock Î±Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î±Î»Î»Î¬Î¾ÎµÎ¹ tab ÎºÎ±Î¹ Î¾Î±Î½Î±Î³Ï…ÏÎ¯ÏƒÎµÎ¹
        document.addEventListener('visibilitychange', () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                requestWakeLock();
            }
        });
    </script>
</body>
</html>
