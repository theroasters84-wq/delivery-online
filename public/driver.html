<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Roasters Driver</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00ff00">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Roasters Driver">

    <style>
        body { font-family: sans-serif; text-align: center; background: #121212; color: white; padding: 20px; }
        .container { max-width: 400px; margin: auto; }
        input { padding: 18px; width: 85%; border-radius: 12px; border: 1px solid #333; background: #222; color: white; margin-bottom: 15px; font-size: 1.1em; }
        .btn-main { background: #00ff00; color: black; border: none; padding: 20px; border-radius: 15px; font-weight: bold; width: 90%; cursor: pointer; font-size: 1.3em; box-shadow: 0 5px #008800; }
        .btn-main:active { transform: translateY(3px); box-shadow: none; }
        .order-card { background: #1e1e1e; padding: 30px; border-radius: 25px; border: 5px solid #ff0000; margin-top: 20px; animation: blink 1s infinite; }
        @keyframes blink { 0% { border-color: #ff0000; } 50% { border-color: #330000; } 100% { border-color: #ff0000; } }
        #status { font-size: 1.2em; margin-top: 10px; color: #00ff00; }
        .btn-logout { background: transparent; color: #666; border: none; text-decoration: underline; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <h1>The Roasters â˜•</h1>

        <div id="login-section">
            <p>Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î¬ ÏƒÎ±Ï‚ Î³Î¹Î± ÏƒÏÎ½Î´ÎµÏƒÎ·:</p>
            <input type="text" id="driver-name-input" placeholder="ÎŒÎ½Î¿Î¼Î± ÎÏ„ÎµÎ»Î¹Î²ÎµÏÎ¬...">
            <button class="btn-main" onclick="initDriver()">Î•ÎÎ•Î¡Î“ÎŸÎ ÎŸÎ™Î—Î£Î—</button>
        </div>

        <div id="profile-section" style="display:none;">
            <h2 id="display-name"></h2>
            <div id="status">ğŸŸ¢ Î Î•Î¡Î™ÎœÎ•ÎÎ© Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î‘...</div>
            <div id="orders-area"></div>
            <button class="btn-logout" onclick="logout()">Î‘Î»Î»Î±Î³Î® Î¿Î½ÏŒÎ¼Î±Ï„Î¿Ï‚</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const publicVapidKey = 'BLWh5oe7cn7f1WZjxkYAUoJiWimKmiQ4psQ-2CkdxXNx2HukkF3ExB4RmUHDakiwTFyHzcs5SKVpRUeAR_pZUMs';
        const alertAudio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        alertAudio.preload = 'auto';

        // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÏŒÎ½Î¿Î¼Î±
        let savedName = localStorage.getItem('driverName');
        if (savedName) {
            document.getElementById('driver-name-input').value = savedName;
        }

        async function initDriver() {
            const name = document.getElementById('driver-name-input').value;
            if (!name) return alert("Î Î±ÏÎ±ÎºÎ±Î»Ï Î²Î¬Î»Îµ Î­Î½Î± ÏŒÎ½Î¿Î¼Î±.");
            
            localStorage.setItem('driverName', name);

            // ÎÎµÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î± Î‰Ï‡Î¿Ï… & Î”ÏŒÎ½Î·ÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿ Ï€ÏÏÏ„Î¿ ÎºÎ»Î¹Îº
            alertAudio.play().then(() => {
                alertAudio.pause();
                alertAudio.currentTime = 0;
            }).catch(err => console.log("Audio unlock failed"));

            if (navigator.vibrate) {
                navigator.vibrate(200);
            }

            setupDriver(name);
        }

        async function setupDriver(name) {
            document.getElementById('login-section').style.display = "none";
            document.getElementById('profile-section').style.display = "block";
            document.getElementById('display-name').innerText = "ÎÏ„ÎµÎ»Î¹Î²ÎµÏÎ¬Ï‚: " + name;
            
            socket.emit('driver-login', name);

            // Î•Î³Î³ÏÎ±Ï†Î® ÏƒÏ„Î± Push Notifications
            if ('serviceWorker' in navigator) {
                try {
                    const register = await navigator.serviceWorker.ready;
                    const subscription = await register.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: publicVapidKey
                    });
                    socket.emit('subscribe-push', subscription);
                    console.log("Push Subscribed!");
                } catch (e) {
                    console.error("Push subscription failed:", e);
                }
            }
        }

        function logout() {
            localStorage.removeItem('driverName');
            location.reload();
        }

        // Î›Î®ÏˆÎ· Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚ (ÏŒÏ„Î±Î½ Î· ÏƒÎµÎ»Î¯Î´Î± ÎµÎ¯Î½Î±Î¹ Î±Î½Î¿Î¹Ï‡Ï„Î®)
        socket.on('new-order', (data) => {
            alertAudio.loop = true;
            alertAudio.play();

            if (navigator.vibrate) {
                // Î£Ï…Î½ÎµÏ‡ÏŒÎ¼ÎµÎ½Î· Î´ÏŒÎ½Î·ÏƒÎ·
                navigator.vibrate([1000, 500, 1000, 500, 1000, 500, 1000]);
            }

            document.getElementById('orders-area').innerHTML = `
                <div class="order-card">
                    <h1 style="color:red; margin:0;">ğŸš¨ ÎÎ•Î‘ ÎšÎ›Î—Î£Î—!</h1>
                    <p>ÎÏÎ±: ${data.time}</p>
                    <button class="btn-main" onclick="accept()">Î‘Î ÎŸÎ”ÎŸÎ§Î— âœ…</button>
                </div>
            `;
            document.getElementById('status').innerText = "ğŸ”´ Î£Î‘Î£ ÎšÎ‘Î›ÎŸÎ¥Î!";
        });

        function accept() {
            alertAudio.pause();
            alertAudio.currentTime = 0;
            if (navigator.vibrate) navigator.vibrate(0);

            const name = localStorage.getItem('driverName');
            socket.emit('order-accepted', { driverName: name });
            
            document.getElementById('orders-area').innerHTML = "";
            document.getElementById('status').innerText = "ğŸŸ¢ Î Î•Î¡Î™ÎœÎ•ÎÎ© Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î‘...";
        }

        // ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Service Worker Î³Î¹Î± PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(() => {
                console.log("Service Worker Registered");
            });
        }
    </script>
</body>
</html>
